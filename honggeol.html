<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>코딩은 밥심 - 안홍걸 Node.js 6</title>
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="hong.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/15de08e773.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <div class="UpperContainer">
      <span class="UpperConent">
        <img src="홍걸.png" />
        <div class="introduce">
          <p>이름 : 안홍걸</p>
          <p>생년월일 : 1996 . 05 . 26</p>
          <a href="https://github.com/4cozm">
            <i id="gitlink" class="fa-brands fa-github"></i>
          </a>
        </div>
      </span>
      <span class="UpperConent">
        <div class="hobby bold">
          취미
          <div>
            <i class="motoContent fa-solid fa-gamepad"></i>
            <i class="motoContent fa-solid fa-book"></i>
          </div>
        </div>
        <div class="moto bold">
          장점&협업 스타일
          <p class="motoContent">#문제 해결을 위해서라면 밤샘도 OK</p>
          <p class="motoContent">#주도적으로 먼저 제시,<br>의견적극 환영</p>
        </div>
        <div class="mbti">
          <p>MBTI</p>
          <p>INTP</p>
        </div>
      </span>
    </div>
    <div class="lowerContainer">
      <form class="visitcomment">
        방명록 작성
        <input
          size="4"
          class="name form-control form-control-sm"
          type="text"
          placeholder="이름"
          aria-label=".form-control-sm example"
        />
        <input
          size="40"
          class="comment form-control form-control-sm"
          type="text"
          placeholder="내용"
          aria-label=".form-control-sm example"
        />
        <input
          class="password"
          size="4"
          type="password"
          placeholder="비밀번호 4자리"
        />
        <button id="commentWrite" type="button">작성</button>
      </form>
    </div>
  </body>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      collection,
      addDoc,
      getDocs,
      where,
      query,
      deleteDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMOlKgeEnac-EPzR347HpkbYsCgHTXccI",
      authDomain: "sparta-cb68a.firebaseapp.com",
      projectId: "sparta-cb68a",
      storageBucket: "sparta-cb68a.appspot.com",
      messagingSenderId: "414469595350",
      appId: "1:414469595350:web:ccfa2aa689cc30916a6977",
      measurementId: "G-FN0GGZEKBH",
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    $("#commentWrite").click(async function () {
      let name = $(".name").val();
      let comment = $(".comment").val();
      let password = $(".password").val();
      let doc = {
        name: name,
        comment: comment,
        password: password,
      };
      let valueCheck = false;
      if (doc.name !== "") {
        if (doc.comment !== "") {
          if (doc.password !== "") {
            valueCheck = true;
          } else {
            alert("비밀번호를 채워주세요");
          }
        } else {
          alert("내용을 채워주세요");
        }
      } else {
        alert("이름을 채워주세요");
      }

      if (valueCheck) {
        await addDoc(collection(db, "comment"), doc).then(() => {
          alert("데이터 등록완료");
          location.reload();
        });
      }
    });

    let docs = await getDocs(collection(db, "comment"));
    docs.forEach((doc) => {
      let row = doc.data();
      let name = row["name"];
      let comment = row["comment"];

      let temp_html = `
      <div class="commentBlock">
        <p class="commentName">${name}:</p> 
        <p class="commentText">${comment}</p>
        <button type="button" class="commentDelete">삭제</button>
        <button type="button" class="commentFix">수정</button>
      </div>`;
      $(".visitcomment").append(temp_html);
    });
    $(".commentDelete").click(async function (event) {
      //삭제하는 코드
      const commentBlock = $(this).closest(".commentBlock");
      const name = commentBlock.find(".commentName").text();
      const comment = commentBlock.find(".commentText").text();
      console.log(name + comment + "deldoc으로 전달!");
      deldoc(name.trim(), comment.trim());
    });

    $(".commentFix").click(async function (event) {
      //수정하는 코드
      const commentBlock = $(this).closest(".commentBlock");
      const name = commentBlock.find(".commentName").text();
      const comment = commentBlock.find(".commentText").text();
      fixdoc(name, comment);
    });

    async function find(name, comment) {
      console.log(name + comment + "find으로 전달!");
      const q = query(
        collection(db, "comment"),
        where("name", "==", name.replace(":", "")), //이름에 콜론이 들어가므로 지워야함
        where("comment", "==", comment)
      );
      const querySnapshot = await getDocs(q);
      return querySnapshot;
    }

    async function deldoc(name, comment) {
      //삭제를 시행하는 코드
      const querySnapshot = await find(name, comment);
      if (!querySnapshot.empty) {
        const bringdoc = querySnapshot.docs[0]; // 비어있지 않으면 첫번째 문서를 가져옴
        const docId = bringdoc.id; //문서 ID
        const password = bringdoc.data().password;
        const userInput = prompt("비밀번호를 입력해주세요");
        if (password === userInput) {
          await deleteDoc(doc(db, "comment", docId));
          alert("데이터가 삭제되었습니다");
          location.reload();
        } else {
          alert("비밀번호가 올바르지 않습니다");
        }
      } else {
        alert("문서 찾기 오류 발생");
      }
    }

    async function fixdoc(name, comment) {
      //수정을 진행하는 코드
      const querySnapshot = await find(name, comment);
      if (!querySnapshot.empty) {
        const bringdoc = querySnapshot.docs[0]; // 비어있지 않으면 첫번째 문서를 가져옴
        const docId = bringdoc.id; //문서 ID
        const password = bringdoc.data().password;
        const userInput = prompt("비밀번호를 입력해주세요");

        if (password === userInput) {
          let userInputName = prompt(
            "데이터를 수정합니다 변경할 이름\n 빈칸으로 놔둘시 기존으로 유지"
          ); //밑에서 수정하니까 상수변수
          let userInputComment = prompt(
            "내용을 수정합니다\n 빈칸으로 놔둘시 기존으로 유지"
          );
          if (userInputName == "" || userInputName == null) {
            userInputName = bringdoc.data().name; //빈칸을 회신 받으면 원래이름대로
          }
          if (userInputComment == "" || userInputComment == null) {
            userInputComment = bringdoc.data().comment; //빈칸을 회신 받으면 원래이름대로
          }
          const newData = {
            name: userInputName,
            comment: userInputComment,
            password: password,
          };
          /*prompt로 데이터 수정중 취소시 Null이 반환됨 고로 or문 이용해 빈칸과 동일한 처리 */
          await updateDoc(bringdoc.ref, newData); //첫번째 인자로 레퍼런스를 받아야함 반환된 object의 구성파악 필요
          alert("데이터가 수정되었습니다");
          location.reload();
        } else {
          alert("비밀번호가 올바르지 않습니다");
        }
      } else {
        alert("문서 찾기 오류 발생");
      }
    }
  </script>
</html>
